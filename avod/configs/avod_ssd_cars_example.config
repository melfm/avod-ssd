# Example cars config with pyramid feature extractor and augmentation
# For each experiment, copy this config and modify the copy

model_config {
    model_name: 'avod_ssd_model'
    checkpoint_name: 'avod_ssd_cars_example'

    input_config {
        bev_depth: 6
        img_depth: 3

        img_dims_w: 1200
        img_dims_h: 360
    }

    model_type {
        avod_ssd {
            avod_config {
                avod_proposal_roi_crop_size: 7
                avod_positive_selection: 'not_bkg'
                avod_nms_size: 100
                avod_nms_iou_thresh: 0.01
                avod_box_representation: 'box_4ca'
            }
        }
    }

    label_smoothing_epsilon: 0.001
    # To disable path drop, set both to 1.0
    path_drop_probabilities: [0.9, 0.9]
    train_on_all_samples: False
    eval_all_samples: False

    layers_config {
        bev_feature_extractor {
            bev_vgg_pyr {
                vgg_conv1: [2, 32]
                vgg_conv2: [2, 64]
                vgg_conv3: [3, 128]
                vgg_conv4: [3, 256]
                l2_weight_decay: 0.0005
            }
            # bev_vgg {
            #     vgg_conv1: [2, 32]
            #     vgg_conv2: [2, 64]
            #     vgg_conv3: [3, 128]
            #     vgg_conv4: [3, 256]
            #     upsampling_multiplier: 4
            #     l2_weight_decay: 0.0005
            # }
        }
        img_feature_extractor {
            img_vgg_pyr {
                vgg_conv1: [2, 32]
                vgg_conv2: [2, 64]
                vgg_conv3: [3, 128]
                vgg_conv4: [3, 256]
                l2_weight_decay: 0.0005
            }
            # img_vgg {
            #     vgg_conv1: [2, 32]
            #     vgg_conv2: [2, 64]
            #     vgg_conv3: [3, 128]
            #     vgg_conv4: [3, 256]
            #     upsampling_multiplier: 4
            #     l2_weight_decay: 0.0005
            # }
        }

        avod_config {
            basic_fc_layers {
                 cls_layer_sizes: [256, 512]
                 off_layer_sizes: [1024, 1024, 1024]
                 ang_layer_sizes: [1024, 1024, 1024]
                 l2_weight_decay: 0.005
                 keep_prob: 0.5
                 fusion_method: 'mean'  # 'mean' or 'concat'
            }
           #fusion_fc_layers {
           #    num_layers: 3
           #    layer_sizes: [2048, 2048, 2048]
           #    l2_weight_decay: 0.005
           #    keep_prob: 0.5
           #    fusion_method: 'mean'  # 'mean' or 'concat'
           #    fusion_type: 'early'  # 'early', 'late', 'deep'
           #}
        }
    }

    # Loss function weights
    loss_config {
        cls_loss_weight: 5.0
        reg_loss_weight: 7.0
        ang_loss_weight: 1.0

        cls_fl_gamma: 2.0
        cls_fl_alpha: 0.25
    }
}

train_config {

    batch_size: 1

    optimizer {
        adam_optimizer {
            learning_rate {
                exponential_decay_learning_rate {
                    initial_learning_rate: 0.0001
                    decay_steps: 100000
                    decay_factor: 0.1
                }
            }
        }
    }

    overwrite_checkpoints: False

    max_checkpoints_to_keep: 10000
    max_iterations: 150000
    checkpoint_interval: 1000

    summary_interval: 10
    summary_histograms: False
    summary_img_images: False
    summary_bev_images: False

    allow_gpu_mem_growth: True
}

eval_config {
    eval_interval: 1000
    eval_mode: 'val'
    ckpt_indices: -1
    evaluate_repeatedly: True

    allow_gpu_mem_growth: True
}

dataset_config {
    name: 'kitti'

    # dataset_dir: '~/Kitti/object'
    # data_split: 'train'

    data_split_dir: 'training'
    has_labels: True

    cluster_split: 'train'
    classes: ['Car']
    num_clusters: [2]

    bev_source: 'lidar'
    aug_list: ['flipping', 'pca_jitter']

    kitti_utils_config {
        area_extents: [-40, 40, -5, 3, 0, 70]
        voxel_size: 0.1
        anchor_strides: [0.5, 0.5]
        density_threshold: 1

        bev_generator {
            slices {
                height_lo: -0.2
                height_hi: 2.3
                num_slices: 5
            }
        }

        mini_batch_config {
            density_threshold: 1

            avod_config {
                iou_2d_thresholds {
                    neg_iou_lo: 0.0
                    neg_iou_hi: 0.55
                    pos_iou_lo: 0.60
                    pos_iou_hi: 1.0
                }

                mini_batch_size: 16384
            }
        }
    }
}
